<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Ù…ØªØ§Ø¨Ø¹Ø© ÙƒÙˆØ±Ø³Ø§Øª (Firebase)</title>

<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

<style>
  /* --- Base Styles (No Change) --- */
  :root{
    --bg:#0f172a; --card:#111827; --muted:#1f2937;
    --accent:#3b82f6; --accent2:#22c55e; --warn:#f59e0b;
    --danger:#ef4444; --text:#e5e7eb; --sub:#cbd5e1;
    --warn-rgb: 245, 158, 11;
  }
  *{box-sizing:border-box}
  body{ margin:0; background:linear-gradient(180deg,#0b1226,#0f172a 50%,#0b1226); color:var(--text); font-family:"Tajawal",system-ui,Arial; font-size:18px; padding-top: 80px; }
  header{ position:fixed; top:0; right:0; left:0; z-index:50; background:rgba(15,23,42,.85); backdrop-filter:blur(8px); border-bottom:1px solid #1e293b; padding: 12px 0; height: 80px; }
  .header-container { max-width:1200px; margin:auto; padding:0 16px; display: flex; justify-content: space-between; align-items: center; gap: 16px; }
  h1{ margin:0; font-size: 22px; white-space: nowrap; }
  /* Welcome message removed for stability */

  .container{max-width:1200px; margin:auto; padding:16px;}
  .subject-selector-container { display: flex; gap: 8px; align-items: center; flex-grow: 1; max-width: 500px; }
  .subject-selector-container select { flex-grow: 1; padding: 8px 12px; font-size: 14px; }
  #addSubjectBtn { padding: 8px 12px; min-width: 40px; font-size: 16px; flex-shrink: 0; }
  .kpis{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
  .kpi{background:#0c1a2e; border:1px solid #173457; padding:8px 12px; border-radius:10px; font-size:16px; text-align: center;}
  .progress-stack { display: grid; gap: 8px; margin-top: 12px; }
  .progress-label { font-size: 14px; color: var(--sub); }
  .bar{height:12px; background:#0b1220; border-radius:999px; overflow:hidden; border:1px solid #1f2a40}
  .bar > span{ display:block; height:100%; background:linear-gradient(90deg,var(--accent),var(--accent2)); width:0%; transition: width 0.3s ease; }
  #blueprintBar > span { background:linear-gradient(90deg,var(--warn), #f00); }
  .toolbar{display:flex; gap:10px; flex-wrap:wrap; margin-top:12px}
  button, select { background:linear-gradient(180deg,#0f2a4a,#0a1f3b); color:#dbeafe; border:1px solid #1e3a5f; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:700; font-size:16px; font-family: inherit; }
  button.secondary{background:#121a2b; color:#cbd5e1; border:1px solid #263146}
  button.danger{background:#2a0f16; border-color:#5f1e29; color:#fecaca}
  button.warn{background:#3f2c0a; border-color:#854d0e; color:#fef3c7}
  .cards{ display:grid; grid-template-columns:1fr; gap:16px; margin:16px auto; }
  .card{ background:linear-gradient(180deg,#0f172a,#0c142a); border:1px solid #18243a; border-radius:18px; box-shadow:0 10px 30px rgba(0,0,0,.25), inset 0 1px 0 rgba(255,255,255,.02); padding: 0; }
  .card-header { padding: 16px; cursor: pointer; display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; flex-wrap: nowrap;}
  .card-header:hover { background: rgba(255,255,255,0.03); }
  .card h2{margin:0; font-size:22px; flex-grow: 1;}
  .card-header .chapter-weight { font-size: 20px; font-weight: 700; color: var(--warn); flex-shrink: 0; }
  .card-content { padding: 0 16px 16px; display: grid; gap: 8px; display: none; }
  .row{ display:grid; grid-template-columns: auto auto 1fr auto auto auto; gap: 10px; align-items:center; padding:10px; border-radius:12px; border:1px solid #1a2742; background:#0b1527; font-size:16px; transition: all 0.2s ease; }
  .row.done{border-color:#1f3f2a; background:#0c1f14} .row.partial{border-color:#3a3214; background:#1c1609}
  .star-btn { background: none; border: none; color: var(--sub); font-size: 22px; cursor: pointer; padding: 0 5px; grid-column: 1; }
  .star-btn.active { color: var(--warn); }
  .row .lecture-weight { grid-column: 2; font-size: 14px; font-weight: 700; color: var(--warn); border-left: 2px solid var(--muted); padding-left: 10px; }
  .row .title{ font-weight:700; grid-column: 3; }
  .snooze-btn { grid-column: 4; background: var(--muted); color: var(--sub); border: 1px solid #2e3d55; padding: 6px 8px; border-radius: 8px; font-size: 16px; cursor: pointer; }
  .row label.chip { grid-column: span 1; }
  .row.snoozed { opacity: 0.4; background: #1a202c; } .row.snoozed .title { text-decoration: line-through; }
  .row.snoozed .snooze-btn { background: var(--warn); color: #000; border-color: var(--warn); }
  .chip{ display:inline-flex; align-items:center; gap:8px; background:#072437; color:#c3e4ff; border:1px solid #0b4a70; padding: 6px 10px; border-radius: 8px; font-size:14px; }
  .chip input{transform:scale(1.2); margin-right: 4px;}
  .modal-back{position:fixed; inset:0; background:rgba(2,6,23,.75); backdrop-filter:blur(6px); display:none; align-items:center; justify-content:center; z-index:100;}
  .modal{width:min(900px,92vw); max-height:80vh; overflow:auto; background:#0a1221; border:1px solid #1a2742; border-radius:16px; padding:16px;}
  .modal h3{margin:0 0 8px; font-size:22px} .divider{height:1px; background:#1d2a44; margin:12px 0}
  .footer{color:#9fb3ca; font-size:14px; margin:32px 0 16px; text-align: center; line-height: 1.6;}
  .footer a { color: var(--accent); text-decoration: none; } .footer a:hover { text-decoration: underline; }
  .form-group{margin-bottom:12px;} .form-group label{display:block; margin-bottom:4px; font-size:16px; color:var(--sub);}
  .form-group input, .form-group textarea, .form-group select{ width:100%; background:#0b1527; border:1px solid #1a2742; color:var(--text); padding:8px 12px; border-radius:8px; font-size:16px; }
  .form-group input[type="date"] { padding: 7px 12px; } .form-group textarea{ min-height: 150px; resize: vertical; }
  .planner-container { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; justify-content: center; }
  .planner-box { background: #0c1a2e; border: 1px solid #173457; border-radius: 10px; padding: 12px 16px; flex-grow: 1; text-align: center; min-width: 150px; position: relative; }
  .planner-box.clickable { cursor: pointer; transition: background-color 0.2s ease; } .planner-box.clickable:hover { background: #173457; }
  .planner-box .label { font-size: 14px; color: var(--sub); margin-bottom: 4px; display: block; }
  .planner-box .value { font-size: 24px; font-weight: 700; color: var(--text); }
  .status-info-icon { font-size: 14px; color: var(--sub); margin-right: 5px; cursor: help; }
  .status-danger { border-color: var(--danger); background: #2a0f16; } .status-danger .value { color: var(--danger); }
  .status-good { border-color: var(--accent2); background: #0c1f14; } .status-good .value { color: var(--accent2); }
  .status-warn { border-color: var(--warn); background: #2a210f; } .status-warn .value { color: var(--warn); }
  .date-picker-hidden { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer; border: none; }
  #mainAppContent { display: none; } #userSection { display: none; align-items: center; gap: 10px; }
  #userImg { width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--accent); }
  #userName { font-size: 14px; font-weight: bold; } #logoutBtn { font-size: 14px; padding: 6px 10px; }
  #loginBtn { display: block; }
  #aboutModal .modal-content { line-height: 1.7; }
  #aboutModal .modal-content h4 { color: var(--warn); margin-top: 1.5em; margin-bottom: 0.5em; }
  #aboutModal .modal-content ul { padding-right: 20px; }
  #aboutModal .modal-content code { background: var(--muted); padding: 2px 6px; border-radius: 4px; font-size: 0.9em; }
  .chapter-progress-container { width: 100px; height: 8px; background: #0b1220; border-radius: 999px; overflow: hidden; border: 1px solid #1f2a40; }
  .chapter-progress-bar { height: 100%; background: linear-gradient(90deg, var(--warn), #ffcc33); width: 0%; transition: width 0.3s ease; }
  .search-container { margin: 16px 0; }
  #searchInput { width: 100%; padding: 12px 16px; font-size: 16px; background: #0c1a2e; border: 1px solid #173457; border-radius: 10px; color: var(--text); }
  .row.highlight { background-color: rgba(245, 158, 11, 0.2); border-color: var(--warn); }
  #starredModal .card { margin-bottom: 12px; padding: 16px;}
  #starredModal .row { grid-template-columns: auto 1fr auto; gap: 15px;}
  #starredModal .completion-status { font-size: 14px; color: var(--sub); text-align: left;}
  #starredModal .completion-status.done { color: var(--accent2); }
  :root { --warn-rgb: 245, 158, 11; }
  #clockDateContainer {
    display: flex;
    gap: 10px;
    align-items: center;
    color: var(--sub);
    font-size: 14px;
    margin-right: auto;
    margin-left: 16px;
    white-space: nowrap;
  }
  #liveClock {
    font-weight: 700;
    color: var(--text);
    background: var(--muted);
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 16px;
    letter-spacing: 1px;
  }
  #liveDate {
    font-size: 12px;
  }
  @media (max-width: 600px) {
    #clockDateContainer { display: none; }
  }
  .chapter-stats {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    font-size: 12px;
    color: var(--sub);
    margin-top: 10px;
    justify-content: flex-end;
  }
  .chapter-stats .stat-item {
    background: #0b1527;
    border: 1px solid #1a2742;
    padding: 2px 6px;
    border-radius: 6px;
  }
  .chapter-stats .stat-item span {
    font-weight: 700;
    color: var(--text);
  }
</style>
</head>
<body>

<header>
  <div class="header-container">
    <div style="display: flex; align-items: center; gap: 16px;">
        <h1 id="headerTitle">Ù…ØªØ§Ø¨Ø¹Ø© ÙƒÙˆØ±Ø³Ø§Øª</h1>
    </div>
    <div id="clockDateContainer">
        <span id="liveDate"></span>
        <span id="liveClock"></span>
    </div>
    <div id="authSection" style="display: flex; align-items: center; gap: 10px; flex-shrink: 0;">
        <div id="userSection"> <img id="userImg" src="" alt="User"/> <span id="userName"></span> <button id="logoutBtn" class="secondary">Ø®Ø±ÙˆØ¬</button> </div>
        <button id="loginBtn" class="warn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    </div>
  </div>
</header>

<main class="container" id="mainAppContent">
  <div class="subject-selector-container"> <select id="subjectSelector"></select> <button id="addSubjectBtn" class="warn">+</button> </div>

  <div class="planner-container">
    <div class="planner-box clickable status-warn" id="daysRemainingBox"> <span class="label">Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</span> <b id="daysRemaining" class="value">-</b> <input type="date" id="datePickerInput" class="date-picker-hidden"> </div>
    <div class="planner-box clickable" id="totalHoursBox"> <span class="label">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</span> <b id="totalHours" class="value">-</b> </div>
    <div class="planner-box" id="remainingHoursBox"> <span class="label">Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©</span> <b id="remainingHours" class="value">-</b> </div>
    <div class="planner-box" id="plannerStatusBox"> <span class="label">Ø­Ø§Ù„ØªÙƒ <span id="planStatusInfo" class="status-info-icon" title="">â“</span></span> <b id="planStatus" class="value">-</b> </div>
    <div class="planner-box" id="plannerLecturesBox"> <span class="label">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙŠÙˆÙ…ÙŠØ§Ù‹ (Ù…Ø­Ø§Ø¶Ø±Ø§Øª)</span> <b id="planLecturesPerDay" class="value">-</b> </div>
    <div class="planner-box" id="plannerHoursBox"> <span class="label">Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙŠÙˆÙ…ÙŠØ§Ù‹ (Ø³Ø§Ø¹Ø§Øª)</span> <b id="planHoursPerDay" class="value">-</b> </div>
  </div>

  <div class="progress-stack"> <div> <div style="display: flex; justify-content: space-between;"> <span class="progress-label">Ø¥Ù†Ø¬Ø§Ø² Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª</span> <b id="globalBarPct" style="font-size: 14px;">0%</b> </div> <div class="bar"><span id="globalBar"></span></div> </div> <div> <div style="display: flex; justify-content: space-between;"> <span class="progress-label">Ø´Ø±ÙŠØ· Ù†Ø³Ø¨Ø© mcq Ø§Ù„Ø¨Ù„ÙˆØ¨Ø±Ù†Øª</span> <b id="blueprintBarPct" style="font-size: 14px; color: var(--warn);">0%</b> </div> <div class="bar" id="blueprintBar"><span id="blueprintBarSpan"></span></div> </div> </div>
  <div class="search-container"> <input type="search" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ø­Ø§Ø¶Ø±Ø©..."> </div>
  <div class="toolbar"> <button class="warn" id="manageDataBtn">Ø¥Ø¯Ø§Ø±Ø©</button> <button class="secondary" id="sortBtn">ÙØ±Ø²</button> <button id="showRemaining">Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</button> <button class="warn" id="showStarredBtn">Ø§Ù„Ù…ÙØ¶Ù„Ø© â­</button> <button class="secondary" id="expandAll">ÙØªØ­ Ø§Ù„ÙƒÙ„</button> <button class="secondary" id="collapseAll">Ø·ÙŠÙ‘ Ø§Ù„ÙƒÙ„</button> <button id="showAboutBtn">Ø´Ø±Ø­</button> </div>
  <div class="kpis" id="globalKpis" style="margin-top:16px"></div> <div class="cards" id="cards"></div>
  <div class="footer"> Ø¨Ø±Ù…Ø¬Ø© ÙˆØªØµÙ…ÙŠÙ…: Ø¹Ù„ÙŠ Ø§Ø­Ù…Ø¯ | Ù„Ù„ØªÙˆØ§ØµÙ„: <a href="https://t.me/draliturki" target="_blank" rel="noopener noreferrer">@draliturki</a> <br> Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø­ÙÙˆØ¸Ø© Ø³Ø­Ø§Ø¨ÙŠØ§Ù‹. </div>
</main>

<div class="modal-back" id="remainingModalBack"> <div class="modal"> <h3>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</h3> <div id="remainingContainer"></div> <div class="divider"></div> <div style="text-align: left;"> <button class="secondary" id="closeRemainingModal">Ø¥ØºÙ„Ø§Ù‚</button> </div> </div> </div>
<div class="modal-back" id="addSubjectModal"> <div class="modal" style="width: min(500px, 90vw);"> <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ø§Ø¯Ø©</h3> <div class="form-group"> <label for="newSubjectNameInput">Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©:</label> <input type="text" id="newSubjectNameInput"/> </div> <div class="divider"></div> <div style="text-align: left;"> <button class="secondary" id="cancelAddSubject">Ø¥Ù„ØºØ§Ø¡</button> <button id="saveNewSubjectBtn" style="margin-right: 8px;">Ø­ÙØ¸</button> </div> </div> </div>
<div class="modal-back" id="manageModalBack"> <div class="modal" id="manageModalContent"> </div> </div>

<div class="modal-back" id="aboutModal">
  <div class="modal">
    <h3>Ø´Ø±Ø­ Ø§Ù„Ù…ÙˆÙ‚Ø¹</h3>
    <div class="modal-content">
        <p>Ø£Ù‡Ù„Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ù…ØªØªØ¨Ø¹ Ø§Ù„ÙƒÙˆØ±Ø³Ø§Øª!</p>
        <p>Ù‡Ø°Ø§ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…ØµÙ…Ù… Ù„Ù…Ø³Ø§Ø¹Ø¯ØªÙƒ Ø¹Ù„Ù‰ ØªÙ†Ø¸ÙŠÙ… Ø¯Ø±Ø§Ø³ØªÙƒ ÙˆØªØªØ¨Ø¹ Ø¥Ù†Ø¬Ø§Ø²Ùƒ Ø¨ÙØ§Ø¹Ù„ÙŠØ©.</p>

        <h4>ğŸ“… Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… (Planner)</h4>
        <ul>
            <li><b>Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:</b> Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ù„Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù…ØªØ­Ø§Ù†.</li>
            <li><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø§Øª:</b> Ø§Ø¶ØºØ· Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠØ© Ù„Ù„Ù…Ø§Ø¯Ø© (ÙŠØ¯ÙˆÙŠØ§Ù‹).</li>
            <li><b>Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:</b> ØªÙØ­Ø³Ø¨ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„ØªÙŠ ØªØ¯Ø®Ù„Ù‡Ø§ Ø¹Ù†Ø¯ Ù…Ø´Ø§Ù‡Ø¯Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆÙ‡Ø§Øª.</li>
            <li><b>Ø­Ø§Ù„ØªÙƒ (â“):</b> ÙŠÙ‚Ø§Ø±Ù† Ø¥Ù†Ø¬Ø§Ø²Ùƒ (Ø§Ù„Ø¨Ù„ÙˆØ¨Ø±Ù†Øª) Ø¨Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ù†Ù‚Ø¶ÙŠ.</li>
        </ul>

        <h4>âš™ï¸ Ø´Ø±ÙŠØ· Ø§Ù„Ø£Ø¯ÙˆØ§Øª</h4>
        <ul>
            <li><b>Ø¥Ø¯Ø§Ø±Ø©:</b> Ù„Ø¥Ø¶Ø§ÙØ© Ø¯ÙƒØ§ØªØ±Ø©ØŒ Ù…Ø­Ø§Ø¶Ø±Ø§ØªØŒ Ø£Ùˆ "Ø¥Ø¯Ø§Ø±Ø© Ø³Ø§Ø¹Ø§Øª Ø§Ù„ÙØµÙˆÙ„".</li>
            <li><b>ÙØ±Ø²:</b> Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¬Ø§Ø¨ØªØ±Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‡Ù…ÙŠØ© (Ø§Ù„ÙˆØ²Ù†).</li>
            <li><b>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ:</b> ÙŠØ¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„ØªÙŠ Ù„Ù… ØªÙƒØªÙ…Ù„ Ø¨Ø¹Ø¯.</li>
            <li><b>Ø§Ù„Ù…ÙØ¶Ù„Ø© â­:</b> ÙŠØ¹Ø±Ø¶ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„ØªÙŠ Ù…ÙŠØ²ØªÙ‡Ø§ Ø¨Ù†Ø¬Ù…Ø©.</li>
        </ul>

        <h4>ğŸ“š Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª ÙˆØ§Ù„Ø¬Ø§Ø¨ØªØ±Ø§Øª</h4>
        <ul>
            <li><b>Ø±Ø£Ø³ Ø§Ù„Ø¬Ø§Ø¨ØªØ±:</b> ÙŠØ¹Ø±Ø¶ Ù„Ùƒ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù‡Ù…Ø© (Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§ØªØŒ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù†Ù‡Ø§ØŒ ÙˆØ¥Ø¬Ù…Ø§Ù„ÙŠ Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ø¬Ø§Ø¨ØªØ±ØŒ ÙˆØ§Ù„Ù…ØªØ¨Ù‚ÙŠ Ù…Ù†Ù‡Ø§).</li>
            <li><b>â˜†/â­:</b> Ù„ØªÙ…ÙŠÙŠØ² Ù…Ø­Ø§Ø¶Ø±Ø© (ÙŠØªØºÙŠØ± Ø´ÙƒÙ„Ù‡Ø§ ÙÙˆØ±Ø§Ù‹).</li>
            <li><b>ğŸš«:</b> Ù„ØªØ¬Ø§Ù‡Ù„ Ù…Ø­Ø§Ø¶Ø±Ø© ÙˆØ¥Ø®Ø±Ø§Ø¬Ù‡Ø§ Ù…Ù† Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„ØªÙ‚Ø¯Ù….</li>
            <li><b>ğŸ¬ ÙÙŠØ¯ÙŠÙˆ:</b> Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„ØµØ­ØŒ Ø³ÙŠØ³Ø£Ù„Ùƒ Ø¹Ù† Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ù„Ø­Ø³Ø§Ø¨ "Ø§Ù„Ø³Ø§Ø¹Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©".</li>
            <li><b>ğŸ“ Ù…Ù„Ø²Ù…Ø©:</b> ØªØ­Ø¯ÙŠØ¯ Ù‡Ø°Ø§ Ø§Ù„Ù…Ø±Ø¨Ø¹ ÙŠØ¹ØªØ¨Ø± Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø© "Ù…ÙƒØªÙ…Ù„Ø©" ÙˆÙŠØ¶ÙŠÙÙ‡Ø§ Ù„Ù†Ø³Ø¨Ø© Ø§Ù„Ø¨Ù„ÙˆØ¨Ø±Ù†Øª.</li>
        </ul>
    </div>
    <div class="divider"></div>
    <div style="text-align: left;"> <button class="secondary" id="closeAboutModal">Ø¥ØºÙ„Ø§Ù‚</button> </div>
  </div>
</div>

<div class="modal-back" id="starredModal"> <div class="modal"> <h3>Ø§Ù„Ù…ÙØ¶Ù„Ø© â­</h3> <div id="starredContainer"></div> <div class="divider"></div> <div style="text-align: left;"> <button class="secondary" id="closeStarredModal">Ø¥ØºÙ„Ø§Ù‚</button> </div> </div> </div>


<script>
// --- Firebase Config & Init (No Change) ---
const firebaseConfig = {
  apiKey: "AIzaSyBizJxYxXnO5u7EIvw6bjfJ3gRbzMJjCdw",
  authDomain: "course-progressing.firebaseapp.com",
  projectId: "course-progressing",
  storageBucket: "course-progressing.appspot.com",
  messagingSenderId: "349314472435",
  appId: "1:349314472435:web:0dd7b5297e02342b4cda86",
};
try { firebase.initializeApp(firebaseConfig); console.log("Firebase Initialized."); }
catch (e) { console.error("Firebase init failed:", e); }
const auth = firebase.auth(); const db = firebase.firestore(); const googleProvider = new firebase.auth.GoogleAuthProvider();

// --- App State (No Change) ---
let currentUser = null; let userId = null; let userDocRef = null;
let appData = {}; let state = {}; let activeSubjectName = null;
let examDate = ""; let totalStudyDays = 0; let isSorted = false;

// --- DOM Elements (No Change) ---
let mainAppContent, userSection, userImg, userName, loginBtn, logoutBtn, cardsEl, subjectSelector,
    daysRemainingEl, daysRemainingBox, datePickerInput, totalHoursEl, totalHoursBox,
    remainingHoursEl, remainingHoursBox,
    plannerStatusBox, planStatus, planLecturesPerDay, globalBar, globalBarPct,
    blueprintBarSpan, blueprintBarPct, headerTitle, addSubjectModal, addSubjectBtn,
    manageModalBack, remainingModalBack, planHoursPerDay, planStatusInfo, aboutModal,
    searchInput, starredModal;

// --- Default Data (No Change) ---
function getDefaultData() { /* ... */ } // Same as before

// --- Firestore Functions (No Change) ---
async function loadDataFromFirestore() { /* ... */ } // Same as before
async function saveAllDataToFirestore() { /* ... */ } // Same as before
async function saveAppData() { /* ... */ } // Same as before
async function saveProgress() { if (!userDocRef) return; try { await userDocRef.update({ state }); } catch (e) { console.error("Err sv Prog:", e); } }
async function saveActiveSubject() { /* ... */ } // Same as before
async function saveExamDateAndDays(newD, newTD) { /* ... */ } // Same as before

// --- Calculation Functions (No Change) ---
function isLectureComplete(rec){ return !!rec?.notes; }
function computeGlobal(subName, subData){ /* ... */ } // Same as before


// --- Rendering Functions (No Change) ---
function renderGlobalHeader(subName, subData, computedGlobal){ /* ... */ } // Same as before
function render(subName, subData, searchTerm = "", openCardIds = []) { /* ... */ } // Same as before


// --- updateEntry Function (Reverted to the last working version regarding hour calculation, but keeping the init() call) ---
async function updateEntry(subName, lec, rowEl, action){
    const k = `${subName}||${lec.chapter}||${lec.title}`;
    const rec = state[k] || {snoozed:!1, starred: !1, videoDuration: null};
    let shouldSave = true;

    // --- 1. Perform Action & Update State Object ---
    if(action === 'video'){
        const isChecking = rowEl.querySelector('[data-action=video]').checked;

        // Prompt logic (Only prompt on first check OR if duration is missing)
        if (isChecking && (rec.videoDuration === null || rec.videoDuration === undefined)) {
            const durationInput = prompt(`ÙƒÙ… Ø³Ø§Ø¹Ø© Ø§Ø³ØªØºØ±Ù‚ ÙÙŠØ¯ÙŠÙˆ "${lec.title}"ØŸ`, "");
            if (durationInput !== null) {
                const duration = parseFloat(durationInput);
                if (!isNaN(duration) && duration >= 0) { // Allow 0 hours
                    rec.videoDuration = duration;
                    rec.video = true;
                } else {
                    alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… ØµØ­ÙŠØ­ Ù„Ù„Ø³Ø§Ø¹Ø§Øª (Ù…Ø«Ù„ 1.5 Ø£Ùˆ 0).");
                    rowEl.querySelector('[data-action=video]').checked = false; // Revert UI
                    shouldSave = false;
                }
            } else {
                rowEl.querySelector('[data-action=video]').checked = false; // Revert UI on cancel
                shouldSave = false;
            }
        } else {
             // Duration exists or unchecking. Just update the video state.
             rec.video = isChecking;
        }
    }
    else if(action === 'notes'){
        rec.notes = rowEl.querySelector('[data-action=notes]').checked;
    }
    else if(action === 'snooze'){
        rec.snoozed = !rec.snoozed;
    }
    else if(action === 'star'){
        rec.starred = !rec.starred;
        const starBtn = rowEl.querySelector('.star-btn');
        if(starBtn) {
            starBtn.classList.toggle('active', rec.starred);
            starBtn.textContent = rec.starred ? 'â­' : 'â˜†';
        }
    }

    // --- 2. Save Block & Re-initialize ---
    if (shouldSave) {
        state[k] = rec;
        try {
            await saveProgress();

            // Re-initialize UI and calculations ONLY if it affects the plan (not just starring)
            if (action !== 'star') {
                const openCardIds = [];
                if(cardsEl) { // Ensure cardsEl is available
                    cardsEl.querySelectorAll('.card-content').forEach(contentEl => {
                        if (contentEl.style.display === 'grid') {
                            openCardIds.push(contentEl.id);
                        }
                    });
                }

                init(openCardIds); // Pass open cards to init

            }
        } catch(e) {
             console.error("Save failed:", e);
        }
    }
}


// --- Planning Functions (No Change) ---
function getDaysRemaining(targetDate = examDate) { /* ... */ } // Same as before
function calculateAndDisplayDays() { /* ... */ } // Same as before
function updateDynamicPlan() { /* ... */ } // Same as before


// --- Modal Functions (No Change) ---
function openAddSubjectModal() { if (!currentUser) return; document.getElementById('newSubjectNameInput').value = ''; addSubjectModal.style.display = 'flex'; }
function closeAddSubjectModal() { addSubjectModal.style.display = 'none'; }
function handleSaveNewSubject() { if (!currentUser) return; const nameIn=document.getElementById('newSubjectNameInput');const name=nameIn.value.trim();if(name&&!appData[name]){appData[name]={totalHours:0,chapters:{},doctors:{}, chapterHours:{}}; saveAppData();activeSubjectName=name;saveActiveSubject();init();closeAddSubjectModal()}else if(!name){alert('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ø§Ø¯Ø©.')}else{alert('Ø§Ù„Ù…Ø§Ø¯Ø© Ù…ÙˆØ¬ÙˆØ¯Ø©.')} }
async function handleSaveChapterHours(e) { if (!currentUser || !activeSubjectName) return; const input = e.target; const chName = input.dataset.chapterName; const hours = parseFloat(input.value); if (chName && !isNaN(hours) && hours >= 0) { if (!appData[activeSubjectName].chapterHours) { appData[activeSubjectName].chapterHours = {}; } appData[activeSubjectName].chapterHours[chName] = hours; await saveAppData(); render(activeSubjectName, appData[activeSubjectName], searchInput ? searchInput.value : ""); } }
function openManageModal() { /* ... */ } // Same as before
function handleAddDoctor() { if(!currentUser)return; const subName=activeSubjectName;const inp=document.getElementById('newDoctorName');const name=inp.value.trim();if(name&&!appData[subName].doctors[name]){appData[subName].doctors[name]=[];saveAppData();init();openManageModal()}else{alert('Ø§Ù„Ø§Ø³Ù… Ù…ÙˆØ¬ÙˆØ¯ Ø£Ùˆ ÙØ§Ø±Øº.')} }
function handleBulkAddLectures() { if(!currentUser)return; const subName=activeSubjectName;const dr=document.getElementById('doctorSelect').value;const txt=document.getElementById('bulkLectures');const tx=txt.value.trim();if(!dr||!tx){alert('Ø§Ø®ØªØ± Ø¯ÙƒØªÙˆØ± ÙˆØ§Ù„ØµÙ‚ Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª.');return} const newLs=tx.split('\n').map(l=>l.trim()).filter(l=>l).map(t=>({title:t,video:"",chapter:"ØºÙŠØ± Ù…ØµÙ†Ù",weight:0}));if(newLs.length>0){const exLs=appData[subName].doctors[dr] || []; appData[subName].doctors[dr]=exLs.concat(newLs);saveAppData();txt.value='';alert(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${newLs.length}.`);init();openManageModal()} }
function setupRemainingModal() { /* ... */ } // Same as before
function setupStarredModal() { /* ... */ } // Same as before

// --- Auth Functions (No Change) ---
async function signInWithGoogle() { console.log("Attempting Google Sign-In..."); try { await auth.signInWithPopup(googleProvider); console.log("Sign-in popup initiated."); } catch (e) { console.error("Sign-in error:", e); if (e.code !== 'auth/popup-closed-by-user') {alert("Ø®Ø·Ø£ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + e.message);} else {console.log("Popup closed.");} } }
async function signOutUser() { console.log("Signing out..."); try { await auth.signOut(); } catch (e) { console.error("Sign-out error:", e); alert("Ø®Ø·Ø£ Ø§Ù„Ø®Ø±ÙˆØ¬: " + e.message); } }

// --- Reset Function (No Change) ---
async function resetAllData() { /* ... */ } // Same as before

// --- Initialization Function (FIXED to accept and pass openCardIds) ---
function init(openCardIds = []){ // Accept optional list of card IDs to reopen
    console.log("%cinit() called.", "color: green; font-weight: bold;");
    if (!currentUser) { console.warn("Cannot init, user not logged in."); return; }
    const subjectKeys = Object.keys(appData);

    // No need to retrieve open cards here, they are passed in or empty

    if (subjectKeys.length === 0) {
        render(null, null, "", openCardIds); // Pass openCardIds
        subjectSelector.innerHTML = '<option>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ÙˆØ§Ø¯</option>';
    } else {
        if (!activeSubjectName || !appData[activeSubjectName]) {
            activeSubjectName = subjectKeys[0];
        }
        subjectSelector.innerHTML = '';
        subjectKeys.forEach(subName => {
            const opt=document.createElement('option');opt.value=subName;opt.textContent=subName;if(subName===activeSubjectName)opt.selected=true; subjectSelector.appendChild(opt);
        });

        // Pass openCardIds to render function
        render(activeSubjectName, appData[activeSubjectName], searchInput ? searchInput.value : "", openCardIds);
    }
    calculateAndDisplayDays();
    updateDynamicPlan();
    console.log("%cinit() finished.", "color: green; font-weight: bold;");

     // FIX: Restore open cards AFTER render is complete
     setTimeout(() => {
        openCardIds.forEach(cardId => {
            const contentEl = document.getElementById(cardId);
            if (contentEl) {
                contentEl.style.display = 'grid';
            }
        });
     }, 0);
}


// --- Clock Function (No Change) ---
function updateClock() { /* ... */ } // Same as before
function startClock() { /* ... */ } // Same as before

// --- Event Listeners Setup (FIXED) ---
document.addEventListener('DOMContentLoaded', () => {
    console.log("DOM loaded. Fetching essential elements first.");

    // --- FETCH AUTH BUTTONS FIRST ---
    loginBtn = document.getElementById('loginBtn');
    logoutBtn = document.getElementById('logoutBtn');

    // --- ATTACH AUTH LISTENERS IMMEDIATELY WITH CHECKS ---
    if (loginBtn) {
        loginBtn.addEventListener('click', signInWithGoogle);
        console.log("%cLogin listener attached successfully.", "color: green;");
    } else {
        console.error("CRITICAL ERROR: Login button ('loginBtn') NOT FOUND!");
        alert("Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„. Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©."); // User feedback
    }

    if (logoutBtn) {
        logoutBtn.addEventListener('click', signOutUser);
        console.log("%cLogout listener attached.", "color: green;");
    } else {
        console.warn("Logout button ('logoutBtn') not found. Might appear after login.");
    }

    // --- Fetch other elements ---
    mainAppContent = document.getElementById('mainAppContent');
    userSection = document.getElementById('userSection');
    userImg = document.getElementById('userImg');
    userName = document.getElementById('userName');
    cardsEl = document.getElementById('cards'); subjectSelector = document.getElementById('subjectSelector');
    daysRemainingEl = document.getElementById('daysRemaining'); daysRemainingBox = document.getElementById('daysRemainingBox'); datePickerInput = document.getElementById('datePickerInput');
    totalHoursEl = document.getElementById('totalHours'); totalHoursBox = document.getElementById('totalHoursBox');
    remainingHoursEl = document.getElementById('remainingHours'); remainingHoursBox = document.getElementById('remainingHoursBox');
    plannerStatusBox = document.getElementById('plannerStatusBox');
    planStatus = document.getElementById('planStatus'); planLecturesPerDay = document.getElementById('planLecturesPerDay'); globalBar = document.getElementById('globalBar');
    globalBarPct = document.getElementById('globalBarPct'); blueprintBarSpan = document.getElementById('blueprintBarSpan'); blueprintBarPct = document.getElementById('blueprintBarPct');
    headerTitle = document.getElementById('headerTitle'); addSubjectModal = document.getElementById('addSubjectModal'); addSubjectBtn = document.getElementById('addSubjectBtn');
    manageModalBack = document.getElementById('manageModalBack'); remainingModalBack = document.getElementById('remainingModalBack');
    planHoursPerDay = document.getElementById('planHoursPerDay'); planStatusInfo = document.getElementById('planStatusInfo'); aboutModal = document.getElementById('aboutModal');
    searchInput = document.getElementById('searchInput'); starredModal = document.getElementById('starredModal');


    console.log("Other elements fetched. Attaching remaining listeners.");
    startClock(); // Start clock after elements are fetched

    // --- Attach other base listeners ---
    if (addSubjectBtn) addSubjectBtn.addEventListener('click', openAddSubjectModal);
    const saveSubjBtn = document.getElementById('saveNewSubjectBtn'); if (saveSubjBtn) saveSubjBtn.addEventListener('click', handleSaveNewSubject);
    const cancelSubjBtn = document.getElementById('cancelAddSubject'); if (cancelSubjBtn) cancelSubjBtn.addEventListener('click', closeAddSubjectModal);
    const manageBtn = document.getElementById('manageDataBtn'); if (manageBtn) manageBtn.addEventListener('click', openManageModal);
    const showRemBtn = document.getElementById('showRemaining'); if (showRemBtn) showRemBtn.addEventListener('click', setupRemainingModal);
    const closeRemBtn = document.getElementById('closeRemainingModal'); if (closeRemBtn) { closeRemBtn.addEventListener('click', () => remainingModalBack.style.display = "none"); }
    const expAllBtn = document.getElementById('expandAll'); if (expAllBtn) expAllBtn.addEventListener('click', ()=>{ document.querySelectorAll('.card-content').forEach(el=> el.style.display = 'grid'); });
    const colAllBtn = document.getElementById('collapseAll'); if (colAllBtn) colAllBtn.addEventListener('click', ()=>{ document.querySelectorAll('.card-content').forEach(el=> el.style.display = 'none'); });
    const sortBtn = document.getElementById('sortBtn'); if (sortBtn) sortBtn.addEventListener('click', ()=>{ isSorted = !isSorted; const btn = sortBtn; if (isSorted) { btn.textContent = "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ÙØ±Ø²"; btn.classList.add('warn'); } else { btn.textContent = "ÙØ±Ø² Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‡Ù…ÙŠØ©"; btn.classList.remove('warn'); } if(currentUser) init(); });
    if (daysRemainingBox) daysRemainingBox.addEventListener('click', () => { if(!currentUser) return; try{ datePickerInput.showPicker(); } catch(e){console.warn("Picker err",e)} });
    if (datePickerInput) datePickerInput.addEventListener('change', (e) => { if(!currentUser) return; const newD = e.target.value; if(newD){ const tDays=getDaysRemaining(newD); saveExamDateAndDays(newD, tDays); calculateAndDisplayDays(); updateDynamicPlan(); } });
    if (totalHoursBox) totalHoursBox.addEventListener('click', () => {
        if(!currentUser) return;
        const subN=activeSubjectName; if(!subN)return; const subData = appData[subN]; if (!subData) return;
        const allChapters = new Set(); Object.values(subData.doctors || {}).forEach(ls => { if(Array.isArray(ls)) { ls.forEach(l => allChapters.add(l.chapter || "ØºÙŠØ± Ù…ØµÙ†Ù")); } });
        const chapterHours = subData.chapterHours || {}; let totalFromChapters = 0; let allChaptersHaveHours = allChapters.size > 0;
        for (const chName of allChapters) { const hours = chapterHours[chName] || 0; if (hours <= 0) { allChaptersHaveHours = false; } totalFromChapters += hours; }
        let message; let defaultVal = subData?.totalHours || 0;
        if (allChaptersHaveHours) { message = `Ø§ÙƒØªÙ…Ù„ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø§Ø¹Ø§Øª ÙƒÙ„ Ø§Ù„ÙØµÙˆÙ„!\nØ§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù‡Ùˆ: ${totalFromChapters.toFixed(1)} Ø³Ø§Ø¹Ø©.\n\nÙ‡Ù„ ØªØ±ÙŠØ¯ Ø§Ø¹ØªÙ…Ø§Ø¯ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… ÙƒÙ€ "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø§Øª"ØŸ\n(Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ÙŠØ¯ÙˆÙŠØŒ Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù…Ø§Ù‹ Ù…Ø®ØªÙ„ÙØ§Ù‹).`; defaultVal = totalFromChapters.toFixed(1); } else { message = `Ø£Ø¯Ø®Ù„ "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø§Ø¹Ø§Øª" ÙŠØ¯ÙˆÙŠØ§Ù‹ Ù„Ù„Ù…Ø§Ø¯Ø©:\n\n(Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ù„Ù† ÙŠØªØºÙŠØ± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø§Ø¹Ø§Øª "Ù„ÙƒÙ„" Ø§Ù„ÙØµÙˆÙ„).`; }
        const input = prompt(message, defaultVal); if (input === null) return; const newTotal = parseFloat(input);
        if (newTotal !== null && !isNaN(newTotal) && newTotal >= 0) { appData[subN].totalHours = newTotal; saveAppData(); init(); }
    });
    if (subjectSelector) subjectSelector.addEventListener('change', (e) => { if(!currentUser) return; const newS=e.target.value; activeSubjectName=newS; saveActiveSubject(); init(); /* Call init on subject change */ });
    const showAboutBtn = document.getElementById('showAboutBtn'); const closeAboutBtn = document.getElementById('closeAboutModal'); if (showAboutBtn && aboutModal && closeAboutBtn) { showAboutBtn.addEventListener('click', () => aboutModal.style.display = 'flex'); closeAboutBtn.addEventListener('click', () => aboutModal.style.display = 'none'); aboutModal.addEventListener('click', (e) => { if(e.target === aboutModal) aboutModal.style.display='none'; }); }
    if (searchInput) { searchInput.addEventListener('input', (e) => { if (currentUser && activeSubjectName) { render(activeSubjectName, appData[activeSubjectName], e.target.value); } }); }
    const showStarredBtn = document.getElementById('showStarredBtn'); const closeStarredBtn = document.getElementById('closeStarredModal'); if (showStarredBtn && starredModal && closeStarredBtn) { showStarredBtn.addEventListener('click', setupStarredModal); closeStarredBtn.addEventListener('click', () => starredModal.style.display = 'none'); starredModal.addEventListener('click', (e) => { if(e.target === starredModal) starredModal.style.display='none'; }); }


    // --- Auth State Observer (No Change) ---
    auth.onAuthStateChanged(async (user) => {
      console.log("Auth state changed:", user ? user.uid : 'null');
      if (user) {
        currentUser = user; userId = user.uid; userDocRef = db.collection('users').doc(userId);
        console.log("User logged in. Loading data...");
        if (userImg && userName && userSection && loginBtn && mainAppContent) {
            userImg.src = user.photoURL || ''; userName.textContent = user.displayName || 'User';
            userSection.style.display = 'flex'; loginBtn.style.display = 'none';
            await loadDataFromFirestore();
            console.log("Data loaded, calling init...");
            init();
            mainAppContent.style.display = 'block';
        } else { console.error("Auth UI elements not found!"); }
      } else {
        currentUser = null; userId = null; userDocRef = null;
        console.log("User logged out.");
        if (userSection && loginBtn && mainAppContent && subjectSelector && cardsEl) {
            userSection.style.display = 'none'; loginBtn.style.display = 'block';
            mainAppContent.style.display = 'none';
            appData = {}; state = {}; activeSubjectName = null; examDate = ""; totalStudyDays = 0; isSorted = false;
            if(subjectSelector) subjectSelector.innerHTML = ''; if(cardsEl) cardsEl.innerHTML = '';
            try { renderGlobalHeader(null, null); updateDynamicPlan(); calculateAndDisplayDays(); } catch(e) {/*ignore*/}
            const sortBtn = document.getElementById('sortBtn'); if (sortBtn) { sortBtn.textContent = "ÙØ±Ø² Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‡Ù…ÙŠØ©"; sortBtn.classList.remove('warn'); }
        } else { console.error("Auth or main UI elements not found!"); }
      }
    });

    console.log("All listeners potentially attached.");
}); // End of DOMContentLoaded
</script>
</body>
</html>
